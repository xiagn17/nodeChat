document.addEventListener("DOMContentLoaded",function(){const e=io.connect(),t=document.body;let n={username:"",usercolor:function(){function e(){return String(255*Math.random())}return"rgb("+e()+", "+e()+", "+e()+")"}()};t.querySelector(".btn-outline-success").addEventListener("click",function(){let o=t.querySelector(".popup"),l=t.querySelector(".username").value,s=/[[\\^$.|?*+()]+/;if(-1!==l.search(s))return alert("Forbidden symbol: "+l.match(s)[0]),!1;if(l){this.disabled=!0;let t,s=[];o.classList.add("opacityToZero"),new Promise(function(e,n){let o=new XMLHttpRequest;o.open("GET","server/onlineUsers.json",!0),o.onload=function(){if(o.status>=200&&o.status<400)t=JSON.parse(o.responseText),e(t);else{let e=new Error(this.statusText);e.code=this.status,n(e)}},o.onerror=function(){n(new Error("JSON didn't load"))},o.send()}).then(function(e){for(let t in e){let n=new RegExp("^"+l+"\\(\\d+\\)$"),o=e[t];-1!==o.username.search(n)?s.push(o):o.username===l&&(s.main=l)}if(s.main)if(0===s.length)n.username=s.main+"(1)";else{let e=0,t=Number(l.length);for(let o=0;o<s.length;o++){let l=s[o].username;if(Number(l.slice(t+1,t+2))-++e!=0){n.username=s.main+"("+String(e)+")";break}o===s.length-1&&(e++,n.username=s.main+"("+String(e)+")")}}else n.username=l}),new Promise(function(e,t){setTimeout(function(){o.classList.remove("opacityToZero"),e("result")},1e3)}).then(function(t){o.style.display="none",e.emit("userPlus",n)})}});let o=t.querySelector(".btn-submit-message"),l=t.querySelector("#textFocus");l.onfocus=function(){this.addEventListener("keyup",function(t){13===(t=t||window.event).keyCode?o.click():8!==t.keyCode&&e.emit("typing",n)})},o.addEventListener("click",function(){let o=t.querySelector(".input-message").value,s=n;if(s.message=o,s.message&&s.username){e.emit("message",s),t.querySelector(".input-message").value="";let n=t.querySelector(".fa-paper-plane");n.style.transform="scale3d(0, 0, 0) rotate(270deg)",setTimeout(function(){n.style.transform=""},350),l.focus()}else s.username||location.reload()});let s=t.querySelector(".app-window-chat");s.addEventListener("DOMNodeInserted",function(e){if(t.querySelector(".typing")){t.querySelector(".typing").style.top=String(s.scrollHeight-25)+"px"}let n=e.target;console.log(s.scrollTop+n.clientHeight+20,"--------",s.scrollHeight-s.clientHeight),s.scrollTop+n.clientHeight+20>s.scrollHeight-s.clientHeight&&(s.scrollTop=s.scrollHeight)}),e.on("typing",function(e){if(n.username!==e.username)if(t.querySelector(".typing")){if(-1===function(e,t){function n(e,t){let n=0;for(let o=0;o<t;o++)n+=e.charCodeAt(o)*Math.pow(2,t-o-1);return n%1046527}for(let o=0;o<e.length-t.length+1;o++){let l=n(t,t.length),s=e.slice(o);if(n(s,t.length)===l){let e=!0;for(let n=0;n<t.length;n++)s[n]!==t[n]&&(e=!1);if(e)return o}}return-1}((r=t.querySelector(".users")).textContent,e.username)){var o=r.textContent.length;r.innerHTML+=", "+e.username}setTimeout(function(){r.textContent.slice(0,o)},2e3)}else{var l=document.createElement("div"),r=document.createElement("div");r.className="users",r.textContent=e.username,l.innerHTML=r.outerHTML+" is typing...",l.className="typing",s.appendChild(l),setTimeout(function(){s.removeChild(l)},2e3)}}),e.on("userPlus",function(e){let n,o=document.createElement("div"),l=document.createElement("div"),r=document.createElement("div");r.className="user",r.textContent=e.username,r.style.color=e.usercolor,o.className="logOut",o.innerHTML="<span>"+e.username+"</span> has joined!",l.className="wrapper",l.appendChild(o),s.appendChild(l),(n=document.documentElement.clientWidth<576?t.querySelector(".slide-online .app-window-online-list"):t.querySelector(".app-window-online-list")).appendChild(r)}),e.on("message",function(e){let t=document.createElement("div"),n=document.createElement("div"),o=document.createElement("div");n.className="name",n.textContent=e.username,n.style.color=e.usercolor,o.className="text",o.textContent=e.message,t.appendChild(n),t.appendChild(o),t.className="message rounded",s.appendChild(t)}),e.on("online",function(e){let n;if((n=document.documentElement.clientWidth<576?t.querySelector(".slide-online .app-window-online-list"):t.querySelector(".app-window-online-list")).innerHTML="","{}"===JSON.stringify(e))return!0;let o=[];for(let t in e){let n=document.createElement("div");n.className="user",n.textContent=e[t].username,n.style.color=e[t].usercolor,o.push(n)}o.forEach(function(e){n.appendChild(e)})}),e.on("writeLogout",function(t){let n=document.createElement("div"),o=document.createElement("div");o.className="logOut",o.innerHTML="<span>"+t+"</span> has disconnected :(",n.className="wrapper",n.appendChild(o),s.appendChild(n),e.emit("online")}),t.querySelector("a.slide-btn").addEventListener("click",function(e){e.preventDefault(),this.classList.toggle("slide-btn-active"),t.querySelector(".slide").classList.toggle("slide-active")})});